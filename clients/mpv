#!/usr/bin/env bash
set -o pipefail
nc_args=("$@")

song_dir="$(emo getpaths songs)"
coproc nc (nc "${nc_args[@]}")
trap 'stop; exit' EXIT

socket="/tmp/mpvsoc-emo"

play() {
	mpv --input-ipc-server="$socket" --no-video "$song_dir/$1" 2>&1 >/dev/null \
	| while read -rd "$(printf '\r')" line; do
		[ -z "$line" ] && continue
		echo "client mpv ${line#*A: }"
	done | nc "${nc_args[@]}" && echo "next" | nc "${nc_args[@]}"
}

stop() {
	read -r play_pid <<< "$(pgrep -P "$$" bash)"
	[ -n "$play_pid" ] && \
		kill "$(ps -f | awk '$3 =='"$play_pid"' && $8 == "mpv" {print $2}')"
	pause=0
}

pause=1
while read -ru "${nc[0]}" cmd; do
	case "$cmd" in
		"exit") stop; exit ;;
		"error empty queue") stop ;;
		"next-is "*)
			stop
			next_is="${cmd#next-is }"
			play "$next_is" &
			pause=1
			;;
		"client mpv toggle")
			echo \
				'{ "command": ["set_property", "pause",' \
				"$(sed "s|1|true|; s|0|false|" <<< "$pause")" \
				'] }' | socat - "$socket"
			((pause = 1 - pause))
			;;
		"client mpv restart")
			stop
			play "$next_is" &
			pause=1
			;;
	esac
done
